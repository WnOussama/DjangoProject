{% load static %}
<div id="chat-card-{{ other_user.username }}" class="card h-100 shadow-sm">

  <!-- header -->
  <div class="card-header d-flex align-items-center">


    <img class="avatar avatar-sm rounded-circle me-2"
         src="{{ other_user.profile.profile_picture.url }}"
         alt="{{ other_user.username }}">
    <h6 class="mb-0 me-4">{{ other_user.get_full_name|default:other_user.username }}</h6>
    
    <div class="f-right">
      <!-- Call button -->
      <a href="#!" class="icon-md rounded-circle btn btn-primary-soft me-2 px-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Audio call"><i class="bi bi-telephone-fill"></i></a>
      <a href="#!" class="icon-md rounded-circle btn btn-primary-soft me-2 px-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Video call"><i class="bi bi-camera-video-fill"></i></a>
    </div>
    <!-- Card action START -->
    
    <!-- small back button for mobile -->
    <button class="btn btn-sm btn-link d-lg-none ms-auto"
            data-bs-toggle="offcanvas"
            data-bs-target="#offcanvasNavbar">
      <i class="fa-solid fa-bars"></i>
    </button>
  </div>

  <!-- messages -->
  <div id="chat-messages"
       class="card-body overflow-auto"
       style="height: calc(100vh - 260px);">
    {% for msg in chats %}
      {% include 'chat/_row.html' with msg=msg %}
    {% empty %}
      <p class="text-center text-muted mt-4">No messages yet – start the conversation!</p>
    {% endfor %}
  </div>

  <!-- composer -->
  <div class="card-footer bg-light">
    <form id="chat-form" class="input-group">
      <input type="text" id="chat-input" class="form-control"
             placeholder="Type a message…" autocomplete="off">
      <button class="btn btn-primary" id="chat-send" type="submit">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </form>
  </div>
</div>

<!-- WebSocket bootstrap -->
<script>
(function () {
  const roomName   = "{{ other_user.username|escapejs }}";
  const myself     = "{{ request.user.username|escapejs }}";
  const chatBody   = document.getElementById('chat-messages');
  const wsScheme   = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${roomName}/`);

  /* ----- incoming messages ----- */
  chatSocket.onmessage = function (e) {
    const { sender, message } = JSON.parse(e.data);

    const wrapper = document.createElement('div');
    wrapper.className = `d-flex ${sender === myself ? 'justify-content-end' : 'justify-content-start'} px-3 py-1`;

    const bubble  = document.createElement('div');
    bubble.className = `${sender === myself ? 'bg-primary text-white' : 'bg-light border'} rounded-3 px-3 py-2 small`;
    bubble.textContent = message;

    wrapper.appendChild(bubble);
    chatBody.appendChild(wrapper);
    chatBody.scrollTop = chatBody.scrollHeight;
  };

  /* ----- outgoing messages ----- */
  document.getElementById('chat-form').addEventListener('submit', function (e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    const text  = input.value.trim();
    if (!text) return;

    if (chatSocket.readyState === WebSocket.OPEN) {
      chatSocket.send(JSON.stringify({ message: text }));
      input.value = '';
      return;
    }

    // HTTP fallback if WS not connected
    const formData = new FormData();
    formData.append('message', text);
    fetch(`/chat/api/send/${encodeURIComponent(roomName)}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '' },
      body: formData
    }).then(r => {
      if (!r.ok) throw new Error('send failed');
      return r.text();
    }).then(html => {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      const node = wrapper.firstElementChild;
      if (node) {
        chatBody.appendChild(node);
        chatBody.scrollTop = chatBody.scrollHeight;
      }
      input.value = '';
    }).catch(console.error);
  });

  chatSocket.onopen  = () => console.log('WS open');
  chatSocket.onerror = (e) => console.error('WS error', e);
  chatSocket.onclose  = () => console.log('WS closed');

  /* always start scrolled to bottom */
  chatBody.scrollTop = chatBody.scrollHeight;
})();
</script>
